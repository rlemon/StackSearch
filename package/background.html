<script type="text/javascript">
function buildURL(page) {
	return "http://api.stackexchange.com/2.0/sites?page=" + page + "&pagesize=100&filter=!LQukQ-uVfJGchnRIp_f0_O&callback=run";
}
function jsonp(url) {
	var script_tag = document.createElement('script');
	script_tag.src = url;
	document.documentElement.appendChild(script_tag);
}
function search_click_handler(info) {
	window.open( ss_site_list[ info.menuItemId - 1 ][0] + '/search?q=' + encodeURIComponent( info.selectionText ) );
}
var make_menus = function() {
	chrome.contextMenus.removeAll(function() {
		ss_site_list = json_to_array(localStorage['ss_site_list']);
		for( var i = 0, l = ss_site_list.length; i < l; i++ ) {
			var menu_child = chrome.contextMenus.create( {
				'title': ss_site_list[i][1],
				'contexts': ['selection'],
				'onclick': search_click_handler
			} );
		}
	});
}
function run(json) {
	se_site_list = se_site_list.concat(json.items);
	if( json.has_more ) {
		jsonp( buildURL(json.page+1) );
	} else {
		make_menus.call();
	}
}

var se_site_list = [], //stackexchange site list
	ss_site_list = []; //stacksearch site list
jsonp( buildURL(1) );
</script>
